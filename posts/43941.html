<!-- build time:Fri Oct 11 2019 00:44:24 GMT+0800 (中国标准时间) --><!DOCTYPE html><html class="theme-next beep use-motion" lang="zh-Hans"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><script src="/lib/pace/pace.min.js?v=1.0.2"></script><link href="/lib/pace/pace-theme-flash.min.css?v=1.0.2" rel="stylesheet"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="https://cdn.bootcss.com/font-awesome/4.6.2/css/font-awesome.min.css" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.ico?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.ico?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="项目笔记,Java Web,SSM框架,高并发,seckill,"><meta name="description" content="1. 高并发优化分析关于并发并发性上不去是因为当多个线程同时访问一行数据时，产生了事务，因此产生写锁，每当一个获取了事务的线程把锁释放，另一个排队线程才能拿到写锁，QPS(Query Per Second每秒查询率)和事务执行的时间有密切关系，事务执行时间越短，并发性越高，这也是要将费时的I/O操作移出事务的原因。在本项目中高并发发生在哪？"><meta name="keywords" content="项目笔记,Java Web,SSM框架,高并发,seckill"><meta property="og:type" content="article"><meta property="og:title" content="Java高并发秒杀API(四)之高并发优化"><meta property="og:url" content="https://lewky.cn/posts/43941.html"><meta property="og:site_name" content="Yulin Lewis&#39; Blog"><meta property="og:description" content="1. 高并发优化分析关于并发并发性上不去是因为当多个线程同时访问一行数据时，产生了事务，因此产生写锁，每当一个获取了事务的线程把锁释放，另一个排队线程才能拿到写锁，QPS(Query Per Second每秒查询率)和事务执行的时间有密切关系，事务执行时间越短，并发性越高，这也是要将费时的I/O操作移出事务的原因。在本项目中高并发发生在哪？"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="https://lewky.cn/images/loading/loading_2.gif"><meta property="og:image" content="https://lewky.cn/images/loading/loading_2.gif"><meta property="og:image" content="https://lewky.cn/images/loading/loading_2.gif"><meta property="og:image" content="https://lewky.cn/images/loading/loading_2.gif"><meta property="og:image" content="https://lewky.cn/images/loading/loading_2.gif"><meta property="og:image" content="https://lewky.cn/images/loading/loading_2.gif"><meta property="og:image" content="https://lewky.cn/images/loading/loading_2.gif"><meta property="og:image" content="https://lewky.cn/images/loading/loading_2.gif"><meta property="og:image" content="https://lewky.cn/images/loading/loading_2.gif"><meta property="og:image" content="https://lewky.cn/images/loading/loading_2.gif"><meta property="og:image" content="https://lewky.cn/images/loading/loading_2.gif"><meta property="og:image" content="https://lewky.cn/images/loading/loading_2.gif"><meta property="og:updated_time" content="2018-11-16T14:11:51.946Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Java高并发秒杀API(四)之高并发优化"><meta name="twitter:description" content="1. 高并发优化分析关于并发并发性上不去是因为当多个线程同时访问一行数据时，产生了事务，因此产生写锁，每当一个获取了事务的线程把锁释放，另一个排队线程才能拿到写锁，QPS(Query Per Second每秒查询率)和事务执行的时间有密切关系，事务执行时间越短，并发性越高，这也是要将费时的I/O操作移出事务的原因。在本项目中高并发发生在哪？"><meta name="twitter:image" content="https://lewky.cn/images/loading/loading_2.gif"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Beep",version:"5.1.4",sidebar:{position:"left",display:"post",offset:6,b2t:!1,scrollpercent:!0,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="https://lewky.cn/posts/43941.html"><script></script><link href="/lib/font-awesome/css/fontawesome-all.min.css" rel="stylesheet" type="text/css"><title>Java高并发秒杀API(四)之高并发优化 | Yulin Lewis' Blog</title><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?6f278ed0fdb01edb3b1e7398379e5432";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"><a href="https://github.com/lewky" target="_blank"><img style="position:absolute;top:0;right:0;border:0" src="/images/headband/forkme_right_red.png" alt="Fork me on GitHub"></a></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Yulin Lewis' Blog</span> <span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">赵子龙一身是<font color="orange">胆</font><br>程序猿遍体皆<font color="red">肝</font></h1></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa-fw fas fa-home"></i><br>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa-fw fas fa-archive"></i><br>文章</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa-fw fas fa-th"></i><br>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa-fw fas fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa-fw fas fa-user"></i><br>关于</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fas fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fas fa-search"></i> </span><span class="popup-btn-close"><i class="far fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><a href="https://github.com/lewky" class="github-corner" target="_blank" title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#222;color:#fff;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://lewky.cn/posts/43941.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="雨临Lewis"><meta itemprop="description" content><meta itemprop="image" content="/images/avatar.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Yulin Lewis' Blog"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">Java高并发秒杀API(四)之高并发优化</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="far fa-calendar-plus"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-06T17:07:54+08:00">2017-10-06 </time></span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/项目笔记/" itemprop="url" rel="index"><span itemprop="name">项目笔记</span> </a></span>， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/项目笔记/seckill/" itemprop="url" rel="index"><span itemprop="name">seckill</span> </a></span></span><span id="/posts/43941.html" class="leancloud_visitors" data-flag-title="Java高并发秒杀API(四)之高并发优化"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fas fa-fire"></i> </span><span class="post-meta-item-text">热度&#58;</span> <span class="leancloud-visitors-count"></span> <span>℃</span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fas fa-book-open"></i> </span><span class="post-meta-item-text">本文共计 &#58;</span> <span title="本文共计">6,110 字 </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅文耗时 &asymp;</span> <span title="阅文耗时">25 min</span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="1-高并发优化分析"><a href="#1-高并发优化分析" class="headerlink" title="1. 高并发优化分析"></a><strong>1. 高并发优化分析</strong></h2><blockquote><p><strong>关于并发</strong></p></blockquote><p>并发性上不去是因为当多个线程同时访问一行数据时，产生了事务，因此产生写锁，每当一个获取了事务的线程把锁释放，另一个排队线程才能拿到写锁，QPS(Query Per Second每秒查询率)和事务执行的时间有密切关系，事务执行时间越短，并发性越高，这也是要将费时的I/O操作移出事务的原因。</p><blockquote><p><strong>在本项目中高并发发生在哪？</strong></p></blockquote><p><img src="/images/loading/loading_2.gif" data-original="/images/posts/project/seckill/高并发发生的地方.jpg" alt="高并发发生的地方"><br><a id="more"></a></p><p>在上图中，红色的部分就表示会发生高并发的地方，绿色部分表示对于高并发没有影响。</p><blockquote><p><strong>为什么需要单独获取系统时间？</strong></p></blockquote><p>这是为了我们的秒杀系统的优化做铺垫。比如在秒杀还未开始的时候，用户大量刷新秒杀商品详情页面是很正常的情况，这时候秒杀还未开始，大量的请求发送到服务器会造成不必要的负担。</p><p>我们将这个详情页放置到CDN中，这样用户在访问该页面时就不需要访问我们的服务器了，起到了降低服务器压力的作用。而CDN中存储的是静态化的详情页和一些静态资源（css，js等），这样我们就拿不到系统的时间来进行秒杀时段的控制，所以我们需要单独设计一个请求来获取我们服务器的系统时间。</p><p><img src="/images/loading/loading_2.gif" data-original="/images/posts/project/seckill/详情页.png" alt="详情页"></p><blockquote><p><strong>CDN（Content Delivery Network）的理解</strong></p></blockquote><p><img src="/images/loading/loading_2.gif" data-original="/images/posts/project/seckill/CDN.jpg" alt="CDN"></p><blockquote><p><strong>获取系统时间不需要优化</strong></p></blockquote><p>因为Java访问一次内存（Cacheline）大约10ns，1s=10亿ns，也就是如果不考虑GC，这个操作1s可以做1亿次。</p><blockquote><p><strong>秒杀地址接口分析</strong></p></blockquote><ul><li>无法使用CDN缓存，因为CDN适合请求对应的资源不变化的，比如静态资源、JavaScript；秒杀地址返回的数据是变化的，不适合放在CDN缓存；</li><li>适合服务端缓存：Redis等，1秒钟可以承受10万qps。多个Redis组成集群，可以到100w个qps. 所以后端缓存可以用业务系统控制。</li></ul><blockquote><p><strong>秒杀地址接口优化</strong></p></blockquote><p><img src="/images/loading/loading_2.gif" data-original="/images/posts/project/seckill/秒杀地址接口优化.jpg" alt="秒杀地址接口优化"></p><blockquote><p><strong>秒杀操作优化分析</strong></p></blockquote><ul><li>无法使用cdn缓存</li><li>后端缓存困难： 库存问题</li><li>一行数据竞争：热点商品</li></ul><p>大部分写的操作和核心操作无法使用CDN，也不可能在缓存中减库存。你在Redis中减库存，那么用户也可能通过缓存来减库存，这样库存会不一致，所以要通过mysql的事务来保证一致性。</p><p>比如一个热点商品所有人都在抢，那么会在同一时间对数据表中的一行数据进行大量的update set操作。</p><p>行级锁在commit之后才释放，所以优化方向是减少行级锁的持有时间。</p><blockquote><p><strong>延迟问题很关键</strong></p></blockquote><ul><li>同城机房网络（0.5ms~2ms），最高并发性是1000qps。</li><li>Update后JVM -GC(垃圾回收机制)大约50ms，最高并发性是20qps。并发性越高，GC就越可能发生，虽然不一定每次都会发生，但一定会发生。</li><li><p>异地机房，比如北京到上海之间的网络延迟，进过计算大概13~20ms。</p><p><img src="/images/loading/loading_2.gif" data-original="/images/posts/project/seckill/网络延迟计算.jpg" alt="网络延迟计算"></p></li></ul><blockquote><p><strong>如何判断update更新库存成功？</strong></p></blockquote><p>有两个条件：</p><ol><li>update自身没报错；</li><li>客户端确认update影响记录数</li></ol><p>优化思路：</p><ul><li>把客户端逻辑放到MySQL服务端，避免网络延迟和GC影响</li></ul><blockquote><p><strong>如何把客户端逻辑放到MySQL服务端</strong></p></blockquote><p>有两种方案：</p><ol><li>定制SQL方案，在每次update后都会自动提交，但需要修改MySQL源码，成本很高，不是大公司（BAT等）一般不会使用这种方法。</li><li>使用存储过程：整个事务在MySQL端完成，用存储过程写业务逻辑，服务端负责调用。</li></ol><p>接下来先分析第一种方案</p><p><img src="/images/loading/loading_2.gif" data-original="/images/posts/project/seckill/秒杀方案1.jpg" alt="秒杀方案1"></p><p><img src="/images/loading/loading_2.gif" data-original="/images/posts/project/seckill/秒杀方案1成本分析.jpg" alt="秒杀方案1成本分析"></p><p>根据上图的成本分析，我们的秒杀系统采用第二种方案，即使用存储过程。</p><blockquote><p><strong>优化总结</strong></p></blockquote><ul><li>前端控制</li></ul><p>暴露接口，按钮防重复（点击一次按钮后就变成灰色，禁止重复点击按钮）</p><ul><li>动静态数据分离</li></ul><p>CDN缓存，后端缓存</p><ul><li>事务竞争优化</li></ul><p>减少事务行级锁的持有时间</p><h2 id="2-Redis后端缓存优化编码"><a href="#2-Redis后端缓存优化编码" class="headerlink" title="2. Redis后端缓存优化编码"></a><strong>2. Redis后端缓存优化编码</strong></h2><blockquote><p><strong>关于CDN的说明</strong></p></blockquote><p>由于不同公司提供的CDN的接口暴露不同，不同的公司租用的机房调用的API也不相同，所以慕课网的视频中并没有对CDN的使用过程进行讲解。</p><h3 id="2-1-下载安装Redis"><a href="#2-1-下载安装Redis" class="headerlink" title="2.1 下载安装Redis"></a><strong>2.1 下载安装Redis</strong></h3><p>前往官网下载安装Stable版本的Redis，安装后可以将安装目录添加到系统变量Path里以方便使用，我使用的是Windows系统的Redis，懒得去官网下载的可以<a href="http://download.csdn.net/download/lewky_liu/10011091" target="_blank" rel="noopener">点这里下载</a>。</p><p>安装后，运行<code>redis-server.exe</code>启动服务器成功，接着运行<code>redis-cli.exe</code>启动客户端连接服务器成功，说明Redis已经安装成功了。</p><blockquote><p><strong>为什么使用Redis</strong></p></blockquote><p>Redis属于NoSQL，即非关系型数据库，它是key-value型数据库，是直接在内存中进行存取数据的，所以有着很高的性能。</p><p>利用Redis可以减轻MySQL服务器的压力，减少了跟数据库服务器的通信次数。秒杀的瓶颈就在于跟数据库服务器的通信速度（MySQL本身的主键查询非常快）</p><h3 id="2-2-在pom-xml中配置Redis客户端"><a href="#2-2-在pom-xml中配置Redis客户端" class="headerlink" title="2.2 在pom.xml中配置Redis客户端"></a><strong>2.2 在pom.xml中配置Redis客户端</strong></h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--添加Redis依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p><strong>Jedis</strong></p></blockquote><p>Redis有很多客户端，我们的项目是用Java语言写的，自然选择对应Java语言的客户端，而官网最推荐我们的Java客户端是Jedis，在pom.xml里配置了Jedis依赖就可以使用它了，记得要先开启Redis的服务器，Jedis才能连接到服务器。</p><p>由于Jedis并没有实现内部序列化操作，而Java内置的序列化机制性能又不高，我们是一个秒杀系统，需要考虑高并发优化，在这里我们采用开源社区提供的更高性能的自定义序列化工具protostuff。</p><h3 id="2-3-在pom-xml中配置protostuff依赖"><a href="#2-3-在pom-xml中配置protostuff依赖" class="headerlink" title="2.3 在pom.xml中配置protostuff依赖"></a><strong>2.3 在pom.xml中配置protostuff依赖</strong></h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--prostuff序列化依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.dyuproject.protostuff<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>protostuff-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.dyuproject.protostuff<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>protostuff-runtime<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p><strong>关于序列化和反序列化</strong></p></blockquote><p>序列化是处理对象流的机制，就是将对象的内容进行流化，可以对流化后的对象进行读写操作，也可以将流化后的对象在网络间传输。反序列化就是将流化后的对象重新转化成原来的对象。</p><p>在Java中内置了序列化机制，通过<code>implements Serializable</code>来标识一个对象实现了序列化接口，不过其性能并不高。</p><h3 id="2-4-使用Redis优化地址暴露接口"><a href="#2-4-使用Redis优化地址暴露接口" class="headerlink" title="2.4 使用Redis优化地址暴露接口"></a><strong>2.4 使用Redis优化地址暴露接口</strong></h3><p>原本查询秒杀商品时是通过主键直接去数据库查询的，选择将数据缓存在Redis，在查询秒杀商品时先去Redis缓存中查询，以此降低数据库的压力。如果在缓存中查询不到数据再去数据库中查询，再将查询到的数据放入Redis缓存中，这样下次就可以直接去缓存中直接查询到。</p><p>以上属于数据访问层的逻辑（DAO层），所以我们需要在dao包下新建一个<code>cache</code>目录，在该目录下新建<code>RedisDao.java</code>，用来存取缓存。</p><blockquote><p><strong>RedisDao</strong></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisDao</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JedisPool jedisPool;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RedisDao</span><span class="params">(String ip, <span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">        jedisPool = <span class="keyword">new</span> JedisPool(ip, port);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RuntimeSchema&lt;Seckill&gt; schema = RuntimeSchema.createFrom(Seckill.class);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Seckill <span class="title">getSeckill</span><span class="params">(<span class="keyword">long</span> seckillId)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// redis操作逻辑</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Jedis jedis = jedisPool.getResource();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                String key = <span class="string">"seckill:"</span> + seckillId;</span><br><span class="line">                <span class="comment">// 并没有实现哪部序列化操作</span></span><br><span class="line">                <span class="comment">// 采用自定义序列化</span></span><br><span class="line">                <span class="comment">// protostuff: pojo.</span></span><br><span class="line">                <span class="keyword">byte</span>[] bytes = jedis.get(key.getBytes());</span><br><span class="line">                <span class="comment">// 缓存重获取到</span></span><br><span class="line">                <span class="keyword">if</span> (bytes != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Seckill seckill = schema.newMessage();</span><br><span class="line">                    ProtostuffIOUtil.mergeFrom(bytes, seckill, schema);</span><br><span class="line">                    <span class="comment">// seckill被反序列化</span></span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> seckill;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                jedis.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">putSeckill</span><span class="params">(Seckill seckill)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Jedis jedis = jedisPool.getResource();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                String key = <span class="string">"seckill:"</span> + seckill.getSeckillId();</span><br><span class="line">                <span class="keyword">byte</span>[] bytes = ProtostuffIOUtil.toByteArray(seckill, schema,</span><br><span class="line">                        LinkedBuffer.allocate(LinkedBuffer.DEFAULT_BUFFER_SIZE));</span><br><span class="line">                <span class="comment">// 超时缓存</span></span><br><span class="line">                <span class="keyword">int</span> timeout = <span class="number">60</span> * <span class="number">60</span>;<span class="comment">// 1小时</span></span><br><span class="line">                String result = jedis.setex(key.getBytes(), timeout, bytes);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                jedis.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>注意</strong></p></blockquote><p>使用protostuff序列化工具时，被序列化的对象必须是pojo对象（具备setter/getter）</p><blockquote><p><strong>在spring-dao.xml中手动注入RedisDao</strong></p></blockquote><p>由于RedisDao和MyBatis的DAO没有关系，MyBatis不会帮我们自动实现该接口，所以我们需要在spring-dao.xml中手动注入RedisDao。由于我们在RedisDao是通过构造方法来注入ip和port两个参数的，所以需要配置<constructor-arg>，如果不配置这个标签，我们需要为ip和port提供各自的setter和getter（注入时可以没有getter）。</constructor-arg></p><p>在这里我们直接把value的值写死在标签里边了，实际开发中需要把ip和port参数的值写到配置文件里，通过读取配置文件的方式读取它们的值。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--redisDao --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"redisDao"</span> <span class="attr">class</span>=<span class="string">"com.lewis.dao.cache.RedisDao"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"0"</span> <span class="attr">value</span>=<span class="string">"localhost"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"1"</span> <span class="attr">value</span>=<span class="string">"6379"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p><strong>修改SeckillServiceImpl</strong></p></blockquote><p>使用注解注入RedisDao属性</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedisDao redisDao;</span><br></pre></td></tr></table></figure><p>修改<code>exportSeckillURI()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Exposer <span class="title">exportSeckillUrl</span><span class="params">(<span class="keyword">long</span> seckillId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 优化点:缓存优化:超时的基础上维护一致性</span></span><br><span class="line">    <span class="comment">// 1.访问redis</span></span><br><span class="line"></span><br><span class="line">    Seckill seckill = redisDao.getSeckill(seckillId);</span><br><span class="line">    <span class="keyword">if</span> (seckill == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 2.访问数据库</span></span><br><span class="line">        seckill = seckillDao.queryById(seckillId);</span><br><span class="line">        <span class="keyword">if</span> (seckill == <span class="keyword">null</span>) &#123;<span class="comment">// 说明查不到这个秒杀产品的记录</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Exposer(<span class="keyword">false</span>, seckillId);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 3.放入redis</span></span><br><span class="line">            redisDao.putSeckill(seckill);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 若是秒杀未开启</span></span><br><span class="line">    Date startTime = seckill.getStartTime();</span><br><span class="line">    Date endTime = seckill.getEndTime();</span><br><span class="line">    <span class="comment">// 系统当前时间</span></span><br><span class="line">    Date nowTime = <span class="keyword">new</span> Date();</span><br><span class="line">    <span class="keyword">if</span> (startTime.getTime() &gt; nowTime.getTime() || endTime.getTime() &lt; nowTime.getTime()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Exposer(<span class="keyword">false</span>, seckillId, nowTime.getTime(), startTime.getTime(), endTime.getTime());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 秒杀开启，返回秒杀商品的id、用给接口加密的md5</span></span><br><span class="line">    String md5 = getMD5(seckillId);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Exposer(<span class="keyword">true</span>, md5, seckillId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-5-测试类RedisDaoTest"><a href="#2-5-测试类RedisDaoTest" class="headerlink" title="2.5 测试类RedisDaoTest"></a><strong>2.5 测试类RedisDaoTest</strong></h3><p>通过IDE工具快速生成测试类RedisDaoTest，新写一个<code>testSeckill()</code>，对getSeckill和putSeckill方法进行全局测试。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner.class)</span><br><span class="line"><span class="comment">// 告诉junit spring的配置文件</span></span><br><span class="line"><span class="meta">@ContextConfiguration</span>(&#123; <span class="string">"classpath:spring/spring-dao.xml"</span> &#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisDaoTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> id = <span class="number">1001</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisDao redisDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SeckillDao seckillDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSeckill</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Seckill seckill = redisDao.getSeckill(id);</span><br><span class="line">        <span class="keyword">if</span> (seckill == <span class="keyword">null</span>) &#123;</span><br><span class="line">            seckill = seckillDao.queryById(id);</span><br><span class="line">            <span class="keyword">if</span> (seckill != <span class="keyword">null</span>) &#123;</span><br><span class="line">                String result = redisDao.putSeckill(seckill);</span><br><span class="line">                logger.info(<span class="string">"result=&#123;&#125;"</span>, result);</span><br><span class="line">                seckill = redisDao.getSeckill(id);</span><br><span class="line">                logger.info(<span class="string">"seckill=&#123;&#125;"</span>, seckill);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果测试通过了，会输出<code>result={}OK</code>以及id为1001的商品信息，如果输出的都是null，那说明你没有开启Redis服务器，所以在内存中没有存取到缓存。</p><blockquote><p><strong>为什么不用Redis的hash来存储对象？</strong></p></blockquote><p>第一：通过Jedis储存对象的方式有大概三种</p><ol><li>本项目采用的方式：将对象序列化成byte字节，最终存byte字节；</li><li>对象转hashmap，也就是你想表达的hash的形式，最终存map；</li><li>对象转json，最终存json，其实也就是字符串</li></ol><p>第二：其实如果你是平常的项目，并发不高，三个选择都可以，这种情况下以hash的形式更加灵活，可以对象的单个属性，但是问题来了，在秒杀的场景下，三者的效率差别很大。</p><p>第三：结果如下</p><table><thead><tr><th>10w数据</th><th>时间</th><th>内存占用</th></tr></thead><tbody><tr><td>存json</td><td>10s</td><td>14M</td></tr><tr><td>存byte</td><td>6s</td><td>6M</td></tr><tr><td>存jsonMap</td><td>10s</td><td>20M</td></tr><tr><td>存byteMap</td><td>4s</td><td>4M</td></tr><tr><td>取json</td><td>7s</td><td></td></tr><tr><td>取byte</td><td>4s</td><td></td></tr><tr><td>取jsonmap</td><td>7s</td><td></td></tr><tr><td>取bytemap</td><td>4s</td></tr></tbody></table><p>第四：你该说了，bytemap最快啊，为啥不用啊，因为项目用了超级强悍的序列化工具啊，以上测试是基于java的序列化，如果改了序列化工具，你可以测试下。</p><p>以上问答源自<a href="http://www.imooc.com/qadetail/233457" target="_blank" rel="noopener">慕课网的一道问答</a></p><blockquote><p><strong>教学视频中张老师对于Redis暴露接口地址的补充</strong></p></blockquote><ol><li>redis事务与RDBMS事务有本质区别，详情见<a href="http://redis.io/topics/transactions" target="_blank" rel="noopener">http://redis.io/topics/transactions</a></li><li>关于spring整合redis。原生Jedis API已经足够清晰。笔者所在的团队不使用任何spring-data整合API，而是直接对接原生Client并做二次开发调优，如Jedis,Hbase等。</li><li>这里使用redis缓存方法用于暴露秒杀地址场景，该方法存在瞬时压力，为了降低DB的primary key QPS，且没有使用库存字段所以不做一致性维护。</li><li>跨数据源的严格一致性需要2PC支持，性能不尽如人意。线上产品一般使用最终一致性去解决，这块相关知识较多，所以没有讲。</li><li>本课程的重点其实不是SSM，只是一个快速开发的方式。重点根据业务场景分析通信成本，瓶颈点的过程和优化思路。</li><li>初学者不要纠结于事务。事务可以降低一致性维护难度，但扩展性灵活性存在不足。技术是死的，人是活的。比如京东抢购使用Redis+LUA+MQ方案，就是一种技术反思。</li></ol><h2 id="3-秒杀操作——并发优化"><a href="#3-秒杀操作——并发优化" class="headerlink" title="3. 秒杀操作——并发优化"></a><strong>3. 秒杀操作——并发优化</strong></h2><h3 id="3-1-简单优化"><a href="#3-1-简单优化" class="headerlink" title="3.1 简单优化"></a><strong>3.1 简单优化</strong></h3><blockquote><p><strong>回顾事务执行</strong></p></blockquote><p><img src="/images/loading/loading_2.gif" data-original="/images/posts/project/seckill/回顾事务执行.jpg" alt="回顾事务执行"></p><blockquote><p><strong>sql语句的简单优化</strong></p></blockquote><p><img src="/images/loading/loading_2.gif" data-original="/images/posts/project/seckill/简单优化.jpg" alt="简单优化"></p><blockquote><p><strong>优化SeckillServiceImpl的<code>executeSeckill()</code></strong></p></blockquote><p>用户的秒杀操作分为两步：减库存、插入购买明细，我们在这里进行简单的优化，就是将原本先update（减库存）再进行insert（插入购买明细）的步骤改成：先insert再update。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> SeckillExecution <span class="title">executeSeckill</span><span class="params">(<span class="keyword">long</span> seckillId, <span class="keyword">long</span> userPhone, String md5)</span> <span class="keyword">throws</span> SeckillException,</span></span><br><span class="line"><span class="function">		RepeatKillException, SeckillCloseException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (md5 == <span class="keyword">null</span> || !md5.equals(getMD5(seckillId))) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SeckillException(<span class="string">"seckill data rewrite"</span>);<span class="comment">// 秒杀数据被重写了</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 执行秒杀逻辑:减库存+增加购买明细</span></span><br><span class="line">    Date nowTime = <span class="keyword">new</span> Date();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 否则更新了库存，秒杀成功,增加明细</span></span><br><span class="line">        <span class="keyword">int</span> insertCount = successKilledDao.insertSuccessKilled(seckillId, userPhone);</span><br><span class="line">        <span class="comment">// 看是否该明细被重复插入，即用户是否重复秒杀</span></span><br><span class="line">        <span class="keyword">if</span> (insertCount &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RepeatKillException(<span class="string">"seckill repeated"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 减库存,热点商品竞争</span></span><br><span class="line">            <span class="keyword">int</span> updateCount = seckillDao.reduceNumber(seckillId, nowTime);</span><br><span class="line">            <span class="keyword">if</span> (updateCount &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 没有更新库存记录，说明秒杀结束 rollback</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SeckillCloseException(<span class="string">"seckill is closed"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 秒杀成功,得到成功插入的明细记录,并返回成功秒杀的信息 commit</span></span><br><span class="line">                SuccessKilled successKilled = successKilledDao.queryByIdWithSeckill(seckillId, userPhone);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> SeckillExecution(seckillId, SeckillStatEnum.SUCCESS, successKilled);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SeckillCloseException e1) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e1;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RepeatKillException e2) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e2;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        logger.error(e.getMessage(), e);</span><br><span class="line">        <span class="comment">// 将编译期异常转化为运行期异常</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SeckillException(<span class="string">"seckill inner error :"</span> + e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>为什么要先insert再update</strong></p></blockquote><p>首先是在更新操作的时候给行加锁，插入并不会加锁，如果更新操作在前，那么就需要执行完更新和插入以后事务提交或回滚才释放锁。而如果插入在前，更新在后，那么只有在更新时才会加行锁，之后在更新完以后事务提交或回滚释放锁。</p><p>在这里，插入是可以并行的，而更新由于会加行级锁是串行的。</p><p>也就是说是更新在前加锁和释放锁之间两次的网络延迟和GC，如果插入在前则加锁和释放锁之间只有一次的网络延迟和GC，也就是减少的持有锁的时间。</p><p>这里先insert并不是忽略了库存不足的情况，而是因为insert和update是在同一个事务里，光是insert并不一定会提交，只有在update成功才会提交，所以并不会造成过量插入秒杀成功记录。</p><h3 id="3-2-深度优化"><a href="#3-2-深度优化" class="headerlink" title="3.2 深度优化"></a><strong>3.2 深度优化</strong></h3><p>前边通过调整insert和update的执行顺序来实现简单优化，但依然存在着Java客户端和服务器通信时的网络延迟和GC影响，我们可以将执行秒杀操作时的insert和update放到MySQL服务端的存储过程里，而Java客户端直接调用这个存储过程，这样就可以避免网络延迟和可能发生的GC影响。另外，由于我们使用了存储过程，也就使用不到Spring的事务管理了，因为在存储过程里我们会直接启用一个事务。</p><h4 id="3-2-1-写一个存储过程procedure，然后在MySQL控制台里执行它"><a href="#3-2-1-写一个存储过程procedure，然后在MySQL控制台里执行它" class="headerlink" title="3.2.1 写一个存储过程procedure，然后在MySQL控制台里执行它"></a><strong>3.2.1 写一个存储过程procedure，然后在MySQL控制台里执行它</strong></h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 秒杀执行储存过程</span></span><br><span class="line">DELIMITER $$ <span class="comment">-- 将定界符从;转换为$$</span></span><br><span class="line"><span class="comment">-- 定义储存过程</span></span><br><span class="line"><span class="comment">-- 参数： in输入参数   out输出参数</span></span><br><span class="line"><span class="comment">-- row_count() 返回上一条修改类型sql(delete,insert,update)的影响行数</span></span><br><span class="line"><span class="comment">-- row_count:0:未修改数据 ; &gt;0:表示修改的行数； &lt;0:sql错误</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> <span class="string">`seckill`</span>.<span class="string">`execute_seckill`</span></span><br><span class="line">  (<span class="keyword">IN</span> v_seckill_id <span class="built_in">BIGINT</span>, <span class="keyword">IN</span> v_phone <span class="built_in">BIGINT</span>,</span><br><span class="line">   <span class="keyword">IN</span> v_kill_time  <span class="keyword">TIMESTAMP</span>, <span class="keyword">OUT</span> r_result <span class="built_in">INT</span>)</span><br><span class="line">  <span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> insert_count <span class="built_in">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">START</span> <span class="keyword">TRANSACTION</span>;</span><br><span class="line">    <span class="keyword">INSERT</span> <span class="keyword">IGNORE</span> <span class="keyword">INTO</span> success_killed</span><br><span class="line">    (seckill_id, user_phone, state)</span><br><span class="line">    <span class="keyword">VALUES</span> (v_seckill_id, v_phone, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">SELECT</span> <span class="keyword">row_count</span>() <span class="keyword">INTO</span> insert_count;</span><br><span class="line">    IF (insert_count = 0) THEN</span><br><span class="line">      <span class="keyword">ROLLBACK</span>;</span><br><span class="line">      <span class="keyword">SET</span> r_result = <span class="number">-1</span>;</span><br><span class="line">    ELSEIF (insert_count &lt; 0) THEN</span><br><span class="line">        <span class="keyword">ROLLBACK</span>;</span><br><span class="line">        <span class="keyword">SET</span> r_result = <span class="number">-2</span>;</span><br><span class="line">    ELSE</span><br><span class="line">      <span class="keyword">UPDATE</span> seckill</span><br><span class="line">      <span class="keyword">SET</span> <span class="built_in">number</span> = <span class="built_in">number</span> - <span class="number">1</span></span><br><span class="line">      <span class="keyword">WHERE</span> seckill_id = v_seckill_id</span><br><span class="line">            <span class="keyword">AND</span> end_time &gt; v_kill_time</span><br><span class="line">            <span class="keyword">AND</span> start_time &lt; v_kill_time</span><br><span class="line">            <span class="keyword">AND</span> <span class="built_in">number</span> &gt; <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">SELECT</span> <span class="keyword">row_count</span>() <span class="keyword">INTO</span> insert_count;</span><br><span class="line">      IF (insert_count = 0) THEN</span><br><span class="line">        <span class="keyword">ROLLBACK</span>;</span><br><span class="line">        <span class="keyword">SET</span> r_result = <span class="number">0</span>;</span><br><span class="line">      ELSEIF (insert_count &lt; 0) THEN</span><br><span class="line">          <span class="keyword">ROLLBACK</span>;</span><br><span class="line">          <span class="keyword">SET</span> r_result = <span class="number">-2</span>;</span><br><span class="line">      ELSE</span><br><span class="line">        <span class="keyword">COMMIT</span>;</span><br><span class="line">        <span class="keyword">SET</span> r_result = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">END</span> <span class="keyword">IF</span>;</span><br><span class="line">    <span class="keyword">END</span> <span class="keyword">IF</span>;</span><br><span class="line">  <span class="keyword">END</span>;</span><br><span class="line">$$</span><br><span class="line"><span class="comment">-- 储存过程定义结束</span></span><br><span class="line"><span class="comment">-- 将定界符重新改为;</span></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 定义一个用户变量r_result</span></span><br><span class="line"><span class="keyword">SET</span> @r_result = <span class="number">-3</span>;</span><br><span class="line"><span class="comment">-- 执行储存过程</span></span><br><span class="line"><span class="keyword">CALL</span> execute_seckill(<span class="number">1003</span>, <span class="number">13502178891</span>, <span class="keyword">now</span>(), @r_result);</span><br><span class="line"><span class="comment">-- 获取结果</span></span><br><span class="line"><span class="keyword">SELECT</span> @r_result;</span><br></pre></td></tr></table></figure><blockquote><p><strong>注意点</strong></p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> <span class="string">`seckill`</span>.<span class="string">`execute_seckill`</span></span><br></pre></td></tr></table></figure><p>上边这句语句的意思是为一个名为<code>seckill</code>的数据库定义一个名为<code>execute_seckill</code>的存储过程，如果你在连接数据库后使用了这个数据库（即<code>use seckill;</code>），那么这里的定义句子就不能这样写了，会报错（因为存储过程是依赖于数据库的），改成下边这样：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> <span class="string">`execute_seckill`</span></span><br></pre></td></tr></table></figure><blockquote><p><strong>row_count()</strong></p></blockquote><p>存储过程中，<code>row_count()</code>函数用来返回上一条sql（delete,insert,update）影响的行数。</p><p>根据row_count()返回值，可以进行接下来的流程判断：</p><p><code>0</code>：未修改数据；</p><p><code>&gt;0</code>: 表示修改的行数；</p><p><code>&lt;0</code>: 表示SQL错误或未执行修改SQL</p><h4 id="3-2-2-修改源码以调用存储过程"><a href="#3-2-2-修改源码以调用存储过程" class="headerlink" title="3.2.2 修改源码以调用存储过程"></a><strong>3.2.2 修改源码以调用存储过程</strong></h4><blockquote><p><strong>在<code>SeckillDao</code>里添加调用存储过程的方法声明</strong></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    *  使用储存过程执行秒杀</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> paramMap</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">killByProcedure</span><span class="params">(Map&lt;String,Object&gt; paramMap)</span></span>;</span><br></pre></td></tr></table></figure><blockquote><p><strong>接着在<code>SeckillDao.xml</code>里添加该方法对应的sql语句</strong></p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--调用储存过程 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"killByProcedure"</span> <span class="attr">statementType</span>=<span class="string">"CALLABLE"</span>&gt;</span></span><br><span class="line">    CALL execute_seckill(</span><br><span class="line">        #&#123;seckillId,jdbcType=BIGINT,mode=IN&#125;,</span><br><span class="line">        #&#123;phone,jdbcType=BIGINT,mode=IN&#125;,</span><br><span class="line">        #&#123;killTime,jdbcType=TIMESTAMP,mode=IN&#125;,</span><br><span class="line">        #&#123;result,jdbcType=INTEGER,mode=OUT&#125;</span><br><span class="line">    )</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p><strong>在<code>SeckillService</code>接口里添加一个方法声明</strong></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 调用存储过程来执行秒杀操作，不需要抛出异常</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> seckillId 秒杀的商品ID</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> userPhone 手机号码</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> md5 md5加密值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 根据不同的结果返回不同的实体信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">SeckillExecution <span class="title">executeSeckillProcedure</span><span class="params">(<span class="keyword">long</span> seckillId,<span class="keyword">long</span> userPhone,String md5)</span></span>;</span><br></pre></td></tr></table></figure><blockquote><p><strong>为什么这个方法不需要抛出异常？</strong></p></blockquote><p>原本没有调用存储过程的执行秒杀操作之所以要抛出RuntimException，是为了让Spring事务管理器能够在秒杀不成功的时候进行回滚操作。而现在我们使用了存储过程，有关事务的提交或回滚已经在procedure里完成了，前面也解释了不需要再使用到Spring的事务了，既然如此，我们也就不需要在这个方法里抛出异常来让Spring帮我们回滚了。</p><blockquote><p><strong>在<code>SeckillServiceImpl</code>里实现这个方法</strong></p></blockquote><p>我们需要使用到第三方工具类，所以在pom.xml里导入commons-collections工具类</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--导入apache工具类--&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在接口的实现类里对<code>executeSeckillProcedure</code>进行实现</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SeckillExecution <span class="title">executeSeckillProcedure</span><span class="params">(<span class="keyword">long</span> seckillId, <span class="keyword">long</span> userPhone, String md5)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (md5 == <span class="keyword">null</span> || !md5.equals(getMD5(seckillId))) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SeckillExecution(seckillId, SeckillStatEnum.DATE_REWRITE);</span><br><span class="line">    &#125;</span><br><span class="line">    Date killTime = <span class="keyword">new</span> Date();</span><br><span class="line">    Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    map.put(<span class="string">"seckillId"</span>, seckillId);</span><br><span class="line">    map.put(<span class="string">"phone"</span>, userPhone);</span><br><span class="line">    map.put(<span class="string">"killTime"</span>, killTime);</span><br><span class="line">    map.put(<span class="string">"result"</span>, <span class="keyword">null</span>);</span><br><span class="line">    <span class="comment">// 执行储存过程,result被复制</span></span><br><span class="line">    seckillDao.killByProcedure(map);</span><br><span class="line">    <span class="comment">// 获取result</span></span><br><span class="line">    <span class="keyword">int</span> result = MapUtils.getInteger(map, <span class="string">"result"</span>, -<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span> (result == <span class="number">1</span>) &#123;</span><br><span class="line">        SuccessKilled successKilled = successKilledDao.queryByIdWithSeckill(seckillId, userPhone);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SeckillExecution(seckillId, SeckillStatEnum.SUCCESS, successKilled);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SeckillExecution(seckillId, SeckillStatEnum.stateOf(result));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接着对该方法进行测试，在原本的<code>SeckillServiceTest</code>测试类里添加测试方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeSeckillProcedure</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> seckillId = <span class="number">1001</span>;</span><br><span class="line">       <span class="keyword">long</span> phone = <span class="number">13680115101L</span>;</span><br><span class="line">       Exposer exposer = seckillService.exportSeckillUrl(seckillId);</span><br><span class="line">       <span class="keyword">if</span> (exposer.isExposed()) &#123;</span><br><span class="line">           String md5 = exposer.getMd5();</span><br><span class="line">           SeckillExecution execution = seckillService.executeSeckillProcedure(seckillId, phone, md5);</span><br><span class="line">           logger.info(<span class="string">"execution=&#123;&#125;"</span>, execution);</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>经过测试，发现没有问题，测试通过。然后我们需要把Controller里的执行秒杀操作改成调用存储过程的方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/&#123;seckillId&#125;/&#123;md5&#125;/execution"</span>,</span><br><span class="line">            method = RequestMethod.POST,</span><br><span class="line">            produces = &#123;<span class="string">"application/json;charset=UTF-8"</span>&#125;)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SeckillResult&lt;SeckillExecution&gt; <span class="title">execute</span><span class="params">(@PathVariable(<span class="string">"seckillId"</span>)</span> Long seckillId,</span></span><br><span class="line"><span class="function">                                                   @<span class="title">PathVariable</span><span class="params">(<span class="string">"md5"</span>)</span> String md5,</span></span><br><span class="line"><span class="function">                                                   @<span class="title">CookieValue</span><span class="params">(value = <span class="string">"userPhone"</span>,required = <span class="keyword">false</span>)</span> Long userPhone)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (userPhone==<span class="keyword">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SeckillResult&lt;SeckillExecution&gt;(<span class="keyword">false</span>,<span class="string">"未注册"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        	<span class="comment">//这里改为调用存储过程</span></span><br><span class="line"><span class="comment">//            SeckillExecution execution = seckillService.executeSeckill(seckillId, userPhone, md5);</span></span><br><span class="line">            SeckillExecution execution = seckillService.executeSeckillProcedure(seckillId, userPhone, md5);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SeckillResult&lt;SeckillExecution&gt;(<span class="keyword">true</span>, execution);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (RepeatKillException e1)</span><br><span class="line">        &#123;</span><br><span class="line">            SeckillExecution execution=<span class="keyword">new</span> SeckillExecution(seckillId, SeckillStatEnum.REPEAT_KILL);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SeckillResult&lt;SeckillExecution&gt;(<span class="keyword">true</span>,execution);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (SeckillCloseException e2)</span><br><span class="line">        &#123;</span><br><span class="line">            SeckillExecution execution=<span class="keyword">new</span> SeckillExecution(seckillId, SeckillStatEnum.END);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SeckillResult&lt;SeckillExecution&gt;(<span class="keyword">true</span>,execution);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception e)</span><br><span class="line">        &#123;</span><br><span class="line">            SeckillExecution execution=<span class="keyword">new</span> SeckillExecution(seckillId, SeckillStatEnum.INNER_ERROR);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SeckillResult&lt;SeckillExecution&gt;(<span class="keyword">true</span>,execution);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>存储过程优化总结</strong></p></blockquote><ol><li>存储过程优化:事务行级锁持有的时间</li><li>不要过度依赖存储过程</li><li>简单的逻辑依赖存储过程</li><li>QPS:一个秒杀单6000/qps</li></ol><p>经过简单优化和深度优化之后，本项目大概能达到一个秒杀单6000qps（慕课网视频中张老师说的），这个数据对于一个秒杀商品来说其实已经挺ok了，注意这里是指同一个秒杀商品6000qps，如果是不同商品不存在行级锁竞争的问题。</p><h3 id="3-3-系统部署架构"><a href="#3-3-系统部署架构" class="headerlink" title="3.3 系统部署架构"></a><strong>3.3 系统部署架构</strong></h3><p><img src="/images/loading/loading_2.gif" data-original="/images/posts/project/seckill/系统可能用到的服务.jpg" alt="系统可能用到的服务"></p><p>CDN：放置一些静态化资源，或者可以将动态数据分离。一些js依赖直接用公网的CDN，自己开发的一些页面也做静态化处理推送到CDN。用户在CDN获取到的数据不需要再访问我们的服务器，动静态分离可以降低服务器请求量。比如秒杀详情页，做成HTML放在cdn上，动态数据可以通过ajax请求后台获取。</p><p>Nginx：作为http服务器，响应客户请求，为后端的servlet容器做反向代理，以达到负载均衡的效果。</p><p>Redis：用来做服务器端的缓存，通过Jedis提供的API来达到热点数据的一个快速存取的过程，减少数据库的请求量。</p><p>MySQL：保证秒杀过程的数据一致性与完整性。</p><p>智能DNS解析+智能CDN加速+Nginx并发+Redis缓存+MySQL分库分表</p><p><img src="/images/loading/loading_2.gif" data-original="/images/posts/project/seckill/大型系统部署架构.jpg" alt="大型系统部署架构"></p><p>大型系统部署架构，逻辑集群就是开发的部分。</p><ol><li>Nginx做负载均衡</li><li>分库分表：在秒杀系统中，一般通过关键的秒杀商品id取模进行分库分表，以512为一张表，1024为一张表。分库分表一般采用开源架构，如阿里巴巴的tddl分库分表框架。</li><li>统计分析：一般使用hadoop等架构进行分析</li></ol><p>在这样一个架构中，可能参与的角色如下：</p><p><img src="/images/loading/loading_2.gif" data-original="/images/posts/project/seckill/项目角色.jpg" alt="项目角色"></p><blockquote><p><strong>本节结语</strong></p></blockquote><p>至此，关于该SSM实战项目——Java高并发秒杀API已经全部完成，感谢观看本文。</p><blockquote><p><strong>项目笔记相关链接</strong></p></blockquote><ul><li><a href="http://blog.csdn.net/lewky_liu/article/details/78159983" target="_blank" rel="noopener"><strong>Java高并发秒杀API(一)之业务分析与DAO层</strong></a></li><li><a href="http://blog.csdn.net/lewky_liu/article/details/78162149" target="_blank" rel="noopener"><strong>Java高并发秒杀API(二)之Service层</strong></a></li><li><a href="http://blog.csdn.net/lewky_liu/article/details/78162153" target="_blank" rel="noopener"><strong>Java高并发秒杀API(三)之Web层</strong></a></li><li><a href="http://blog.csdn.net/lewky_liu/article/details/78166080" target="_blank" rel="noopener"><strong>Java高并发秒杀API(四)之高并发优化</strong></a></li></ul><blockquote><p><strong>项目源码</strong></p></blockquote><ul><li><a href="http://download.csdn.net/download/lewky_liu/10013556" target="_blank" rel="noopener"><strong>源码下载</strong></a></li><li><a href="https://github.com/lewky/Seckill" target="_blank" rel="noopener"><strong>GitHub地址</strong></a></li></ul><blockquote><p><strong>项目视频教程链接</strong></p></blockquote><p>这是慕课网上的一个免费项目教学视频，名为Java高并发秒杀API，一共有如下四节课程，附带视频传送门（在视频中老师是用IDEA，本文用的是Eclipse）</p><ul><li><a href="http://www.imooc.com/learn/587" target="_blank" rel="noopener">Java高并发秒杀API之业务分析与DAO层</a></li><li><a href="http://www.imooc.com/learn/631" target="_blank" rel="noopener">Java高并发秒杀API之Service层</a></li><li><a href="http://www.imooc.com/learn/630" target="_blank" rel="noopener">Java高并发秒杀API之Web层</a></li><li><a href="http://www.imooc.com/learn/632" target="_blank" rel="noopener">Java高并发秒杀API之高并发优化</a></li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/项目笔记/" rel="tag"><i class="fas fa-tag"></i> 项目笔记</a> <a href="/tags/Java-Web/" rel="tag"><i class="fas fa-tag"></i> Java Web</a> <a href="/tags/SSM框架/" rel="tag"><i class="fas fa-tag"></i> SSM框架</a> <a href="/tags/高并发/" rel="tag"><i class="fas fa-tag"></i> 高并发</a> <a href="/tags/seckill/" rel="tag"><i class="fas fa-tag"></i> seckill</a></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong> 雨临Lewis</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="https://lewky.cn/posts/43941.html" title="Java高并发秒杀API(四)之高并发优化">https://lewky.cn/posts/43941.html</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议，转载请注明出处！</li></ul></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/posts/33818.html" rel="next" title="Java高并发秒杀API(三)之Web层"><i class="fas fa-chevron-left"></i> Java高并发秒杀API(三)之Web层</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/posts/86689e1.html" rel="prev" title="Maven - 关于编码GBK的不可映射字符的问题">Maven - 关于编码GBK的不可映射字符的问题 <i class="fas fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"></div></div></div><div class="comments" id="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC8zNzIyMS8xMzc1NQ=="></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-avatar-plug-bilibili"> <img class="site-author-image-bilibili" itemprop="image" src="/images/avatar.jpg" alt="点击头像试试看~~"><p class="site-author-name" itemprop="name">雨临Lewis</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">169</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">53</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">102</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/lewky" target="_blank" title="GitHub"><i class="fa-fw fab fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:1019175915@qq.com" target="_blank" title="E-Mail"><i class="fa-fw fas fa-envelope"></i>E-Mail</a> </span><span class="links-of-author-item"><a href="https://blog.csdn.net/lewky_liu" target="_blank" title="CSDN"><i class="fa-fw fab fa-cuttlefish"></i>CSDN</a> </span><span class="links-of-author-item"><a href="http://www.cnblogs.com/yulinlewis" target="_blank" title="博客园"><i class="fa-fw fas fa-book"></i>博客园</a> </span><span class="links-of-author-item"><a href="/" target="_blank" title="站点首页"><i class="fa-fw fas fa-home"></i>站点首页</a> </span><span class="links-of-author-item"><a href="/posts/e62c38c4.html" target="_blank" title="建站日志"><i class="fa-fw fas fa-cog fa-spin"></i>建站日志</a></span></div><div class="cc-license motion-element" itemprop="license"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a></div><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class="links-of-blogroll-title"><i class="fa-fw link"></i> <i class="fas fa-hand-holding-heart fa-flip-horizontal"></i> 神奇链接 <i class="fas fa-hand-holding-heart"></i></div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="/posts/5044311b.html" title="Java工程师成神之路(2018版本)" target="_blank">Java工程师成神之路(2018版本)</a></li><li class="links-of-blogroll-item"><a href="/high/" title="前方高能，High♂起来!!!" target="_blank">前方高能，High♂起来!!!</a></li><li class="links-of-blogroll-item"><a href="/posts/d65a1577.html" title="随笔" target="_blank">随笔</a></li></ul></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-高并发优化分析"><span class="nav-text">1. 高并发优化分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Redis后端缓存优化编码"><span class="nav-text">2. Redis后端缓存优化编码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-下载安装Redis"><span class="nav-text">2.1 下载安装Redis</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-在pom-xml中配置Redis客户端"><span class="nav-text">2.2 在pom.xml中配置Redis客户端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-在pom-xml中配置protostuff依赖"><span class="nav-text">2.3 在pom.xml中配置protostuff依赖</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-使用Redis优化地址暴露接口"><span class="nav-text">2.4 使用Redis优化地址暴露接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-测试类RedisDaoTest"><span class="nav-text">2.5 测试类RedisDaoTest</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-秒杀操作——并发优化"><span class="nav-text">3. 秒杀操作——并发优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-简单优化"><span class="nav-text">3.1 简单优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-深度优化"><span class="nav-text">3.2 深度优化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-1-写一个存储过程procedure，然后在MySQL控制台里执行它"><span class="nav-text">3.2.1 写一个存储过程procedure，然后在MySQL控制台里执行它</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-2-修改源码以调用存储过程"><span class="nav-text">3.2.2 修改源码以调用存储过程</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-系统部署架构"><span class="nav-text">3.3 系统部署架构</span></a></li></ol></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2019</span> <span class="with-love"><i class="fas fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">雨临Lewis</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fas fa-chart-area"></i> </span><span class="post-meta-item-text">全站共计字数&#58;</span> <span title="全站共计字数">123.5k</span></div><div class="footer-custom">备案号：<a target="_blank" href="http://www.beian.miit.gov.cn/" style="font-weight:700">粤ICP备19103822</a> <span class="post-meta-divider">|</span> Hosted by <a href="https://pages.coding.me" style="font-weight:700">Coding Pages</a> & <a target="_blank" href="https://pages.github.com" style="font-weight:700">GitHub Pages</a></div></div></footer><div class="back-to-top"><i class="fas fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div><div class="sidebar_wo"><div id="leimu"><img src="/images/b2t/leimuA.png" alt="雷姆" onmouseover='this.src="/images/b2t/leimuB.png"' onmouseout='this.src="/images/b2t/leimuA.png"' title="回到顶部"></div><div class="sidebar_wo" id="lamu"><img src="/images/b2t/lamuA.png" alt="雷姆" onmouseover='this.src="/images/b2t/lamuB.png"' onmouseout='this.src="/images/b2t/lamuA.png"' title="回到底部"></div></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script type="text/javascript">!function(e,t){var n,c=e.getElementsByTagName(t)[0];"function"!=typeof LivereTower&&(n=e.createElement(t),n.src="https://cdn-city.livere.com/js/embed.dist.js",n.async=!0,c.parentNode.insertBefore(n,c))}(document,"script")</script><script type="text/javascript">function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var t=$("#local-search-input");t.attr("autocapitalize","none"),t.attr("autocorrect","off"),t.focus()}var isfetched=!1,isXml=!0,search_path="search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(t){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")},searchFunc=function(t,e,o){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:t,dataType:isXml?"xml":"json",async:!0,success:function(t){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var n=isXml?$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():t,r=document.getElementById(e),s=document.getElementById(o),a=function(){var t=r.value.trim().toLowerCase(),e=t.split(/[\s\-]+/);e.length>1&&e.push(t);var o=[];if(t.length>0&&n.forEach(function(n){function r(e,o,n,r){for(var s=r[r.length-1],a=s.position,i=s.word,l=[],h=0;a+i.length<=n&&0!=r.length;){i===t&&h++,l.push({position:a,length:i.length});var p=a+i.length;for(r.pop();0!=r.length&&(s=r[r.length-1],a=s.position,i=s.word,p>a);)r.pop()}return c+=h,{hits:l,start:o,end:n,searchTextCount:h}}function s(t,e){var o="",n=e.start;return e.hits.forEach(function(e){o+=t.substring(n,e.position);var r=e.position+e.length;o+='<b class="search-keyword">'+t.substring(e.position,r)+"</b>",n=r}),o+=t.substring(n,e.end)}var a=!1,i=0,c=0,l=n.title.trim(),h=l.toLowerCase(),p=n.content.trim().replace(/<[^>]+>/g,""),u=p.toLowerCase(),f=decodeURIComponent(n.url),d=[],g=[];if(""!=l&&(e.forEach(function(t){function e(t,e,o){var n=t.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(e=e.toLowerCase(),t=t.toLowerCase());(s=e.indexOf(t,r))>-1;)a.push({position:s,word:t}),r=s+n;return a}d=d.concat(e(t,h,!1)),g=g.concat(e(t,u,!1))}),(d.length>0||g.length>0)&&(a=!0,i=d.length+g.length)),a){[d,g].forEach(function(t){t.sort(function(t,e){return e.position!==t.position?e.position-t.position:t.word.length-e.word.length})});var v=[];0!=d.length&&v.push(r(l,0,l.length,d));for(var $=[];0!=g.length;){var C=g[g.length-1],m=C.position,x=C.word,w=m-20,y=m+80;0>w&&(w=0),y<m+x.length&&(y=m+x.length),y>p.length&&(y=p.length),$.push(r(p,w,y,g))}$.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hits.length!==e.hits.length?e.hits.length-t.hits.length:t.start-e.start});var T=parseInt("1");T>=0&&($=$.slice(0,T));var b="";b+=0!=v.length?"<li><a href='"+f+"' class='search-result-title'>"+s(l,v[0])+"</a>":"<li><a href='"+f+"' class='search-result-title'>"+l+"</a>",$.forEach(function(t){b+="<a href='"+f+'\'><p class="search-result">'+s(p,t)+"...</p></a>"}),b+="</li>",o.push({item:b,searchTextCount:c,hitCount:i,id:o.length})}}),1===e.length&&""===e[0])s.innerHTML='<div id="no-result"><i class="fas fa-search fa-5x" /></div>';else if(0===o.length)s.innerHTML='<div id="no-result"><i class="far fa-frown fa-5x" /></div>';else{o.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hitCount!==e.hitCount?e.hitCount-t.hitCount:e.id-t.id});var a='<ul class="search-result-list">';o.forEach(function(t){a+=t.item}),a+="</ul>",s.innerHTML=a}};r.addEventListener("input",a),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(t){t.stopPropagation(),isfetched===!1?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(t){t.stopPropagation()}),$(document).on("keyup",function(t){var e=27===t.which&&$(".search-popup").is(":visible");e&&onPopupClose()})</script><script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script><script>AV.initialize("1OiMg9cMz7owGf7apX4mTQs3-gzGzoHsz","nfafLPsFBNTdO9Sb5suuGdpG")</script><script>function showTime(e){var t=new AV.Query(e),n=[],o=$(".leancloud_visitors");o.each(function(){n.push($(this).attr("id").trim())}),t.containedIn("url",n),t.find().done(function(e){var t=".leancloud-visitors-count";if(0===e.length)return void o.find(t).text(0);for(var i=0;i<e.length;i++){var r=e[i],s=r.get("url"),l=r.get("time"),c=document.getElementById(s);$(c).find(t).text(l)}for(var i=0;i<n.length;i++){var s=n[i],c=document.getElementById(s),u=$(c).find(t);""==u.text()&&u.text(0)}}).fail(function(e,t){console.log("Error: "+t.code+" "+t.message)})}function addCount(e){var t=$(".leancloud_visitors"),n=t.attr("id").trim(),o=t.attr("data-flag-title").trim(),i=new AV.Query(e);i.equalTo("url",n),i.find({success:function(t){if(t.length>0){var i=t[0];i.fetchWhenSave(!0),i.increment("time"),i.save(null,{success:function(e){var t=$(document.getElementById(n));t.find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to save Visitor num, with error message: "+t.message)}})}else{var r=new e,s=new AV.ACL;s.setPublicReadAccess(!0),s.setPublicWriteAccess(!0),r.setACL(s),r.set("title",o),r.set("url",n),r.set("time",1),r.save(null,{success:function(e){var t=$(document.getElementById(n));t.find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to create")}})}},error:function(e){console.log("Error:"+e.code+" "+e.message)}})}$(function(){var e=AV.Object.extend("Counter");1==$(".leancloud_visitors").length?addCount(e):$(".post-title-link").length>1&&showTime(e)})</script><script>!function(){var t=document.createElement("script"),s=window.location.protocol.split(":")[0];"https"===s?t.src="https://zz.bdstatic.com/linksubmit/push.js":t.src="http://push.zhanzhang.baidu.com/push.js";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}()</script><script src="https://cdn.bootcss.com/jquery-backstretch/2.0.4/jquery.backstretch.min.js"></script><script type="text/javascript" src="/lib/zclip/clipboard.min.js"></script><script>$(function(){$(".site-avatar-plug-bilibili").attr("src","/images/avatar-plug/bilibili_"+(~~(44*Math.random())+1)+".png")})</script><script type="text/javascript" src="/js/src/custom.js"></script><script>!function(t){function e(t,e){var n=new Image,o=t.getAttribute("data-original");n.onload=function(){t.src=o,e&&e()},n.src=o}function n(){for(var n=0;n<o.length;n++)i=o[n],0<=(c=i.getBoundingClientRect()).top&&0<=c.left&&c.top<=(t.innerHeight||document.documentElement.clientHeight)&&e(o[n],function(){o.splice(n,n)});var i,c;console.log("trigger")}var o=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));n(),t.addEventListener("scroll",function(){var e,o;e=n,o=t,clearTimeout(e.tId),e.tId=setTimeout(function(){e.call(o)},500)})}(this)</script></body></html><!-- rebuild by neat -->