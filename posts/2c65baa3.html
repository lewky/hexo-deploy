<!-- build time:Thu Nov 14 2019 00:14:44 GMT+0800 (中国标准时间) --><!DOCTYPE html><html class="theme-next beep use-motion" lang="zh-Hans"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><script src="/lib/pace/pace.min.js?v=1.0.2"></script><link href="/lib/pace/pace-theme-flash.min.css?v=1.0.2" rel="stylesheet"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="https://cdn.bootcss.com/font-awesome/4.6.2/css/font-awesome.min.css" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.ico?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.ico?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="Java相关框架,log4j2,log4j,"><meta name="description" content="应用场景与问题当项目在运行时，我们如果需要修改log4j 1.X或者log4j2的配置文件，一般来说我们是不能直接将项目停止运行再来修改文件重新部署的。于是就有这样一个问题：如何在不停止当前项目的运行的情况下，让系统能够自动地监控配置文件的修改状况，从而实现动态加载配置文件的功能？而log4j 1.X和log4j2的差别略大，各自应该怎么实现这个功能？log4j 1.X动态加载配置文件log4j"><meta name="keywords" content="Java相关框架,log4j2,log4j"><meta property="og:type" content="article"><meta property="og:title" content="log4j和log4j2怎么动态加载配置文件"><meta property="og:url" content="https://lewky.cn/posts/2c65baa3.html"><meta property="og:site_name" content="Yulin Lewis&#39; Blog"><meta property="og:description" content="应用场景与问题当项目在运行时，我们如果需要修改log4j 1.X或者log4j2的配置文件，一般来说我们是不能直接将项目停止运行再来修改文件重新部署的。于是就有这样一个问题：如何在不停止当前项目的运行的情况下，让系统能够自动地监控配置文件的修改状况，从而实现动态加载配置文件的功能？而log4j 1.X和log4j2的差别略大，各自应该怎么实现这个功能？log4j 1.X动态加载配置文件log4j"><meta property="og:locale" content="zh-Hans"><meta property="og:updated_time" content="2019-05-03T16:19:26.315Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="log4j和log4j2怎么动态加载配置文件"><meta name="twitter:description" content="应用场景与问题当项目在运行时，我们如果需要修改log4j 1.X或者log4j2的配置文件，一般来说我们是不能直接将项目停止运行再来修改文件重新部署的。于是就有这样一个问题：如何在不停止当前项目的运行的情况下，让系统能够自动地监控配置文件的修改状况，从而实现动态加载配置文件的功能？而log4j 1.X和log4j2的差别略大，各自应该怎么实现这个功能？log4j 1.X动态加载配置文件log4j"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Beep",version:"5.1.4",sidebar:{position:"left",display:"post",offset:6,b2t:!1,scrollpercent:!0,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="https://lewky.cn/posts/2c65baa3.html"><script></script><link href="/lib/font-awesome/css/fontawesome-all.min.css" rel="stylesheet" type="text/css"><title>log4j和log4j2怎么动态加载配置文件 | Yulin Lewis' Blog</title><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?6f278ed0fdb01edb3b1e7398379e5432";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"><a href="https://github.com/lewky" target="_blank"><img style="position:absolute;top:0;right:0;border:0" src="/images/headband/forkme_right_red.png" alt="Fork me on GitHub"></a></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Yulin Lewis' Blog</span> <span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">赵子龙一身是<font color="orange">胆</font><br>程序猿遍体皆<font color="red">肝</font></h1></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa-fw fas fa-home"></i><br>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa-fw fas fa-archive"></i><br>文章</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa-fw fas fa-th"></i><br>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa-fw fas fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa-fw fas fa-user"></i><br>关于</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fas fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fas fa-search"></i> </span><span class="popup-btn-close"><i class="far fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><a href="https://github.com/lewky" class="github-corner" target="_blank" title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#222;color:#fff;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://lewky.cn/posts/2c65baa3.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="雨临Lewis"><meta itemprop="description" content><meta itemprop="image" content="/images/avatar.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Yulin Lewis' Blog"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">log4j和log4j2怎么动态加载配置文件</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="far fa-calendar-plus"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-28T00:34:44+08:00">2018-12-28 </time></span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Java相关框架/" itemprop="url" rel="index"><span itemprop="name">Java相关框架</span> </a></span>， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Java相关框架/日志框架/" itemprop="url" rel="index"><span itemprop="name">日志框架</span> </a></span></span><span id="/posts/2c65baa3.html" class="leancloud_visitors" data-flag-title="log4j和log4j2怎么动态加载配置文件"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fas fa-fire"></i> </span><span class="post-meta-item-text">热度&#58;</span> <span class="leancloud-visitors-count"></span> <span>℃</span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fas fa-book-open"></i> </span><span class="post-meta-item-text">本文共计 &#58;</span> <span title="本文共计">2,213 字 </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅文耗时 &asymp;</span> <span title="阅文耗时">10 min</span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="应用场景与问题"><a href="#应用场景与问题" class="headerlink" title="应用场景与问题"></a>应用场景与问题</h2><p>当项目在运行时，我们如果需要修改log4j 1.X或者log4j2的配置文件，一般来说我们是不能直接将项目停止运行再来修改文件重新部署的。于是就有这样一个问题：如何在不停止当前项目的运行的情况下，让系统能够自动地监控配置文件的修改状况，从而实现动态加载配置文件的功能？而log4j 1.X和log4j2的差别略大，各自应该怎么实现这个功能？</p><h2 id="log4j-1-X动态加载配置文件"><a href="#log4j-1-X动态加载配置文件" class="headerlink" title="log4j 1.X动态加载配置文件"></a>log4j 1.X动态加载配置文件</h2><p>log4j 1.X提供了动态加载配置文件的方法：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DOMConfigurator.configureAndWatch()</span><br><span class="line">PropertyConfigurator.onfigureAndWatch()</span><br></pre></td></tr></table></figure><p></p><p><code>DOMConfigurator</code>对应的是xml配置文件，<code>PropertyConfigurator</code>对应的是properties配置文件。这两个类都有<code>configureAndWatch</code>这个方法，该方法有个重载方法，如下：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">configureAndWatch(String configFilename)</span><br><span class="line">configureAndWatch(String configFilename, <span class="keyword">long</span> delay)</span><br></pre></td></tr></table></figure><p></p><p><code>configureAndWatch</code>方法用来监控配置文件是否被改动，监控的时间间隔是<code>delay</code>参数来决定，如果不传入该参数则使用默认的时间间隔1分钟(60000L)。<code>configureAndWatch(String configFilename)</code>实际上还是调用的<code>configureAndWatch(String configFilename, long delay)</code>。</p><h2 id="log4j2动态加载配置文件"><a href="#log4j2动态加载配置文件" class="headerlink" title="log4j2动态加载配置文件"></a>log4j2动态加载配置文件</h2><p>和log4j 1.X比起来，log4j2的动态加载配置很简单就能实现，不需要另外在代码中调用api，方法如下：<br></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span> <span class="attr">monitorInterval</span>=<span class="string">"30"</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>在log4j2.xml配置文件中的<code>configuration</code>节点添加<code>monitorInterval</code>的值，单位是秒，如果配置的值大于0，则会按照时间间隔来自动扫描配置文件是否被修改，并在修改后重新加载最新的配置文件。如果不配置该值，默认为0，即不扫描配置文件是否被修改。<br><a id="more"></a></p><h2 id="Log4j-1-X动态加载配置文件的底层实现原理"><a href="#Log4j-1-X动态加载配置文件的底层实现原理" class="headerlink" title="Log4j 1.X动态加载配置文件的底层实现原理"></a>Log4j 1.X动态加载配置文件的底层实现原理</h2><h3 id="DOMConfigurator-configureAndWatch源码解析"><a href="#DOMConfigurator-configureAndWatch源码解析" class="headerlink" title="DOMConfigurator#configureAndWatch源码解析"></a>DOMConfigurator#configureAndWatch源码解析</h3><p>org.apache.log4j.xml.DOMConfigurator#configureAndWatch源码如下：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureAndWatch</span><span class="params">(String configFilename, <span class="keyword">long</span> delay)</span> </span>&#123;</span><br><span class="line">    XMLWatchdog xdog = <span class="keyword">new</span> XMLWatchdog(configFilename);</span><br><span class="line">    xdog.setDelay(delay);</span><br><span class="line">    xdog.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>这里new了一个XMLWatchdog对象，接着设置了delay参数，最后调用了start()方法。<br>watchdog是看门狗、检查者的意思，XMLWatchdog继承了FileWatchdog这个类，在XMLWatchdog中仅仅重写了doOnChange方法：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doOnChange</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">new</span> DOMConfigurator().doConfigure(filename, LogManager.getLoggerRepository());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>从方法名就可以看出来，如果XMLWatchdog监控到配置文件被改动了，就会调用这个doOnChange方法，用来重新加载配置文件。那么它又是怎么知道配置文件被改动过了呢？接着看其父类FileWatchdog的源码：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">FileWatchdog</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">     The default delay between every file modification check, set to 60</span></span><br><span class="line"><span class="comment">     seconds.  */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">public</span> <span class="keyword">long</span> DEFAULT_DELAY = <span class="number">60000</span>; </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">     The name of the file to observe  for changes.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">protected</span> String filename;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">     The delay to observe between every check. By default set &#123;<span class="doctag">@link</span></span></span><br><span class="line"><span class="comment">     #DEFAULT_DELAY&#125;. */</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">long</span> delay = DEFAULT_DELAY; </span><br><span class="line">  </span><br><span class="line">  File file;</span><br><span class="line">  <span class="keyword">long</span> lastModif = <span class="number">0</span>; </span><br><span class="line">  <span class="keyword">boolean</span> warnedAlready = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">boolean</span> interrupted = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="title">FileWatchdog</span><span class="params">(String filename)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(<span class="string">"FileWatchdog"</span>);</span><br><span class="line">    <span class="keyword">this</span>.filename = filename;</span><br><span class="line">    file = <span class="keyword">new</span> File(filename);</span><br><span class="line">    setDaemon(<span class="keyword">true</span>);</span><br><span class="line">    checkAndConfigure();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">     Set the delay to observe between each check of the file changes.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDelay</span><span class="params">(<span class="keyword">long</span> delay)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.delay = delay;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">abstract</span> <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doOnChange</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">checkAndConfigure</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> fileExists;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      fileExists = file.exists();</span><br><span class="line">    &#125; <span class="keyword">catch</span>(SecurityException  e) &#123;</span><br><span class="line">      LogLog.warn(<span class="string">"Was not allowed to read check file existance, file:["</span>+</span><br><span class="line">          filename+<span class="string">"]."</span>);</span><br><span class="line">      interrupted = <span class="keyword">true</span>; <span class="comment">// there is no point in continuing</span></span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(fileExists) &#123;</span><br><span class="line">      <span class="keyword">long</span> l = file.lastModified(); <span class="comment">// this can also throw a SecurityException</span></span><br><span class="line">      <span class="keyword">if</span>(l &gt; lastModif) &#123;           <span class="comment">// however, if we reached this point this</span></span><br><span class="line">    lastModif = l;              <span class="comment">// is very unlikely.</span></span><br><span class="line">    doOnChange();</span><br><span class="line">    warnedAlready = <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span>(!warnedAlready) &#123;</span><br><span class="line">    LogLog.debug(<span class="string">"["</span>+filename+<span class="string">"] does not exist."</span>);</span><br><span class="line">    warnedAlready = <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;    </span><br><span class="line">    <span class="keyword">while</span>(!interrupted) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        Thread.sleep(delay);</span><br><span class="line">      &#125; <span class="keyword">catch</span>(InterruptedException e) &#123;</span><br><span class="line">    <span class="comment">// no interruption expected</span></span><br><span class="line">      &#125;</span><br><span class="line">      checkAndConfigure();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>可以看到，FileWatchdog继承了Thread类，类里定义了几个成员变量，比如默认的监控时间间隔等。而在该类的构造方法中可以看到，首先该线程类将名字设定成<code>FileWatchdog</code>，接着根据传入的配置文件的路径new了一个File对象，然后该线程类又设置成了守护线程(daemon thread)，最后调用了<code>checkAndConfigure()</code>。</p><p>在<code>checkAndConfigure()</code>中，则是对new出来的配置文件File对象进行检查是否存在该文件，若不存在该文件则会设置成员变量的值，这样就不会去监控不存在的配置文件了。如果该配置文件存在，则通过<code>lastModified()</code>来获取文件的最后更新时间，和上次的更新时间作对比，如果比上次更新时间大则会调用<code>doOnChange()</code>来重新加载配置文件。</p><p>而在FileWatchdog的run方法中，则是在无限循环中先让线程睡眠设置好的监控时间间隔，然后调用<code>checkAndConfigure()</code>。</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>可以看出，在log4j 1.X的DOMConfigurator中，是通过创建一个守护线程来不停地扫描配置文件的最后更新时间，并和上次的更新时间进行对比，如果最后更新时间大于上次更新时间则会重新加载配置文件。</p><h3 id="PropertyConfigurator-configureAndWatch源码解析"><a href="#PropertyConfigurator-configureAndWatch源码解析" class="headerlink" title="PropertyConfigurator#configureAndWatch源码解析"></a>PropertyConfigurator#configureAndWatch源码解析</h3><p>PropertyConfigurator的<code>configureAndWatch()</code>其实和DOMConfigurator差不多，区别是PropertyConfigurator在方法里new了一个PropertyWatchdog对象，PropertyWatchdog和XMLWatchdog一样继承了FileWatchdog，一样重写了doOnChange()方法。只是PropertyWatchdog是通过new PropertyConfigurator().doConfigure()来加载配置文件的。</p><p>从源码实现来看，无论是使用xml配置文件，还是使用properties配置文件，其动态加载配置文件的底层实现是基本一样的。可以通过解析配置文件的文件后缀来判断是xml还是properties文件，然后调用对应的方法即可，大概的思路如下：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">boolean</span> flag = <span class="keyword">true</span>;</span><br><span class="line"><span class="keyword">boolean</span> isXml = StringUtils.equalsIgnoreCase(<span class="string">"xml"</span>, StringUtils.substringAfterLast(filepath, <span class="string">"."</span>));</span><br><span class="line">ling delay = <span class="number">30000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (isXml) &#123;</span><br><span class="line">  <span class="keyword">if</span> (flag) &#123;</span><br><span class="line">    DOMConfigurator.configureAndWatch(filepath, delay);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    DOMConfigurator.configure(filepath);</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (flag) &#123;</span><br><span class="line">    PropertyConfigurator.configureAndWatch(filepath, delay);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    PropertyConfigurator.configure(filepath);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h2 id="log4j2底层实现动态加载配置文件的简单解析"><a href="#log4j2底层实现动态加载配置文件的简单解析" class="headerlink" title="log4j2底层实现动态加载配置文件的简单解析"></a>log4j2底层实现动态加载配置文件的简单解析</h2><p>虽然log4j2的动态加载配置很简单，但其底层实现比起log4j 1.X却要复杂很多，使用到了很多并发包下的类，具体也不是很了解，这里简单解释下流程。</p><p>对于log4j2.xml文件，对应的是<code>org.apache.logging.log4j.core.config.xml.XmlConfiguration</code>这个类。如果在log4j2.xml里配置了monitorInterval，在构建XmlConfiguration时会根据该值来走一段特定的逻辑：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">final</span> Map.Entry&lt;String, String&gt; entry : attrs.entrySet()) &#123;</span><br><span class="line">    <span class="keyword">final</span> String key = entry.getKey();</span><br><span class="line">    <span class="keyword">final</span> String value = getStrSubstitutor().replace(entry.getValue());</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">"status"</span>.equalsIgnoreCase(key)) &#123;</span><br><span class="line">        statusConfig.withStatus(value);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"dest"</span>.equalsIgnoreCase(key)) &#123;</span><br><span class="line">        statusConfig.withDestination(value);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"shutdownHook"</span>.equalsIgnoreCase(key)) &#123;</span><br><span class="line">        isShutdownHookEnabled = !<span class="string">"disable"</span>.equalsIgnoreCase(value);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"shutdownTimeout"</span>.equalsIgnoreCase(key)) &#123;</span><br><span class="line">        shutdownTimeoutMillis = Long.parseLong(value);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"verbose"</span>.equalsIgnoreCase(key)) &#123;</span><br><span class="line">        statusConfig.withVerbosity(value);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"packages"</span>.equalsIgnoreCase(key)) &#123;</span><br><span class="line">        pluginPackages.addAll(Arrays.asList(value.split(Patterns.COMMA_SEPARATOR)));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"name"</span>.equalsIgnoreCase(key)) &#123;</span><br><span class="line">        setName(value);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"strict"</span>.equalsIgnoreCase(key)) &#123;</span><br><span class="line">        strict = Boolean.parseBoolean(value);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"schema"</span>.equalsIgnoreCase(key)) &#123;</span><br><span class="line">        schemaResource = value;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"monitorInterval"</span>.equalsIgnoreCase(key)) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> intervalSeconds = Integer.parseInt(value);</span><br><span class="line">        <span class="keyword">if</span> (intervalSeconds &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            getWatchManager().setIntervalSeconds(intervalSeconds);</span><br><span class="line">            <span class="keyword">if</span> (configFile != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> FileWatcher watcher = <span class="keyword">new</span> ConfiguratonFileWatcher(<span class="keyword">this</span>, listeners);</span><br><span class="line">                getWatchManager().watchFile(configFile, watcher);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"advertiser"</span>.equalsIgnoreCase(key)) &#123;</span><br><span class="line">        createAdvertiser(value, configSource, buffer, <span class="string">"text/xml"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>可以看到，如果monitorInterval的值大于0，则会拿到WatchManager并设置扫描配置文件的时间间隔，如果配置文件存在，则会new一个ConfiguratonFileWatcher对象，并将配置文件和该对象一起传递给WatchManager的watchFile方法。这两个方法的底层实现很绕，比起log4j 1.X要复杂得多，不容易看懂。不过最终实现的效果还是一样的，依然会开启一个守护线程来监控配置文件是否被改动。</p><p>区别在于，log4j2使用线程池来启动线程，在<code>WatchManager#start()</code>里实现的：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.start();</span><br><span class="line">    <span class="keyword">if</span> (intervalSeconds &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        future = scheduler.scheduleWithFixedDelay(<span class="keyword">new</span> WatchRunnable(), intervalSeconds, intervalSeconds,</span><br><span class="line">                TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>而该方法则是在启动配置文件时被调用的，<code>AbstractConfiguration#start()</code>：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Start the configuration.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Preserve the prior behavior of initializing during start if not initialized.</span></span><br><span class="line">    <span class="keyword">if</span> (getState().equals(State.INITIALIZING)) &#123;</span><br><span class="line">        initialize();</span><br><span class="line">    &#125;</span><br><span class="line">    LOGGER.debug(<span class="string">"Starting configuration &#123;&#125;"</span>, <span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">this</span>.setStarting();</span><br><span class="line">    <span class="keyword">if</span> (watchManager.getIntervalSeconds() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        watchManager.start();</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>这里只是简单解析了下主要的流程，具体的实现细节目前还看不太懂，有兴趣的可以自己去看看log4j2的源码。另外我在官方文档里看到说<code>monitorInterval</code>的最小值是5，但是在源码里也没看到这个，我觉得只要配置值大于0应该就是可以的。有不对之处，欢迎指出。</p><p>这是官方原文：</p><blockquote><p>###Automatic Reconfiguration<br>When configured from a File, Log4j has the ability to automatically detect changes to the configuration file and reconfigure itself. If the monitorInterval attribute is specified on the configuration element and is set to a non-zero value then the file will be checked the next time a log event is evaluated and/or logged and the monitorInterval has elapsed since the last check. The example below shows how to configure the attribute so that the configuration file will be checked for changes only after at least 30 seconds have elapsed. The minimum interval is 5 seconds.</p></blockquote><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul><li><a href="https://www.oschina.net/translate/the-new-log4j-2-0?lang=chs&amp;p=1" target="_blank" rel="noopener">Log4j 2.0 的新特性</a></li><li><a href="http://logging.apache.org/log4j/2.x/manual/configuration.html#AutomaticConfiguration" target="_blank" rel="noopener">Log4j – Configuring Log4j 2 - Apache Log4j 2</a></li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Java相关框架/" rel="tag"><i class="fas fa-tag"></i> Java相关框架</a> <a href="/tags/log4j2/" rel="tag"><i class="fas fa-tag"></i> log4j2</a> <a href="/tags/log4j/" rel="tag"><i class="fas fa-tag"></i> log4j</a></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong> 雨临Lewis</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="https://lewky.cn/posts/2c65baa3.html" title="log4j和log4j2怎么动态加载配置文件">https://lewky.cn/posts/2c65baa3.html</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议，转载请注明出处！</li></ul></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/posts/f53d27da.html" rel="next" title="log4j2中LevelRangeFilter的注意点"><i class="fas fa-chevron-left"></i> log4j2中LevelRangeFilter的注意点</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/posts/55fa957a.html" rel="prev" title="升级log4j到log4j2报错：cannot access org.apache.http.annotation.NotThreadSafe">升级log4j到log4j2报错：cannot access org.apache.http.annotation.NotThreadSafe <i class="fas fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"></div></div></div><div class="comments" id="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC8zNzIyMS8xMzc1NQ=="></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-avatar-plug-bilibili"> <img class="site-author-image-bilibili" itemprop="image" src="/images/avatar.jpg" alt="点击头像试试看~~"><p class="site-author-name" itemprop="name">雨临Lewis</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">171</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">54</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">104</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/lewky" target="_blank" title="GitHub"><i class="fa-fw fab fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:1019175915@qq.com" target="_blank" title="E-Mail"><i class="fa-fw fas fa-envelope"></i>E-Mail</a> </span><span class="links-of-author-item"><a href="https://blog.csdn.net/lewky_liu" target="_blank" title="CSDN"><i class="fa-fw fab fa-cuttlefish"></i>CSDN</a> </span><span class="links-of-author-item"><a href="http://www.cnblogs.com/yulinlewis" target="_blank" title="博客园"><i class="fa-fw fas fa-book"></i>博客园</a> </span><span class="links-of-author-item"><a href="/" target="_blank" title="站点首页"><i class="fa-fw fas fa-home"></i>站点首页</a> </span><span class="links-of-author-item"><a href="/posts/e62c38c4.html" target="_blank" title="建站日志"><i class="fa-fw fas fa-cog fa-spin"></i>建站日志</a></span></div><div class="cc-license motion-element" itemprop="license"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a></div><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class="links-of-blogroll-title"><i class="fa-fw link"></i> <i class="fas fa-hand-holding-heart fa-flip-horizontal"></i> 神奇链接 <i class="fas fa-hand-holding-heart"></i></div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="/posts/5044311b.html" title="Java工程师成神之路(2018版本)" target="_blank">Java工程师成神之路(2018版本)</a></li><li class="links-of-blogroll-item"><a href="/high/" title="前方高能，High♂起来!!!" target="_blank">前方高能，High♂起来!!!</a></li><li class="links-of-blogroll-item"><a href="/posts/d65a1577.html" title="随笔" target="_blank">随笔</a></li></ul></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#应用场景与问题"><span class="nav-number">1.</span> <span class="nav-text">应用场景与问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#log4j-1-X动态加载配置文件"><span class="nav-number">2.</span> <span class="nav-text">log4j 1.X动态加载配置文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#log4j2动态加载配置文件"><span class="nav-number">3.</span> <span class="nav-text">log4j2动态加载配置文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Log4j-1-X动态加载配置文件的底层实现原理"><span class="nav-number">4.</span> <span class="nav-text">Log4j 1.X动态加载配置文件的底层实现原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#DOMConfigurator-configureAndWatch源码解析"><span class="nav-number">4.1.</span> <span class="nav-text">DOMConfigurator#configureAndWatch源码解析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#总结"><span class="nav-number">4.2.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PropertyConfigurator-configureAndWatch源码解析"><span class="nav-number">4.3.</span> <span class="nav-text">PropertyConfigurator#configureAndWatch源码解析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#log4j2底层实现动态加载配置文件的简单解析"><span class="nav-number">5.</span> <span class="nav-text">log4j2底层实现动态加载配置文件的简单解析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考链接"><span class="nav-number">6.</span> <span class="nav-text">参考链接</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2019</span> <span class="with-love"><i class="fas fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">雨临Lewis</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fas fa-chart-area"></i> </span><span class="post-meta-item-text">全站共计字数&#58;</span> <span title="全站共计字数">126.1k</span></div><div class="footer-custom">备案号：<a target="_blank" href="http://www.beian.miit.gov.cn/" style="font-weight:700">粤ICP备19103822</a> <span class="post-meta-divider">|</span> Hosted by <a href="https://pages.coding.me" style="font-weight:700">Coding Pages</a> & <a target="_blank" href="https://pages.github.com" style="font-weight:700">GitHub Pages</a></div></div></footer><div class="back-to-top"><i class="fas fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div><div class="sidebar_wo"><div id="leimu"><img src="/images/b2t/leimuA.png" alt="雷姆" onmouseover='this.src="/images/b2t/leimuB.png"' onmouseout='this.src="/images/b2t/leimuA.png"' title="回到顶部"></div><div class="sidebar_wo" id="lamu"><img src="/images/b2t/lamuA.png" alt="雷姆" onmouseover='this.src="/images/b2t/lamuB.png"' onmouseout='this.src="/images/b2t/lamuA.png"' title="回到底部"></div></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script type="text/javascript">!function(e,t){var n,c=e.getElementsByTagName(t)[0];"function"!=typeof LivereTower&&(n=e.createElement(t),n.src="https://cdn-city.livere.com/js/embed.dist.js",n.async=!0,c.parentNode.insertBefore(n,c))}(document,"script")</script><script type="text/javascript">function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var t=$("#local-search-input");t.attr("autocapitalize","none"),t.attr("autocorrect","off"),t.focus()}var isfetched=!1,isXml=!0,search_path="search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(t){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")},searchFunc=function(t,e,o){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:t,dataType:isXml?"xml":"json",async:!0,success:function(t){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var n=isXml?$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():t,r=document.getElementById(e),s=document.getElementById(o),a=function(){var t=r.value.trim().toLowerCase(),e=t.split(/[\s\-]+/);e.length>1&&e.push(t);var o=[];if(t.length>0&&n.forEach(function(n){function r(e,o,n,r){for(var s=r[r.length-1],a=s.position,i=s.word,l=[],h=0;a+i.length<=n&&0!=r.length;){i===t&&h++,l.push({position:a,length:i.length});var p=a+i.length;for(r.pop();0!=r.length&&(s=r[r.length-1],a=s.position,i=s.word,p>a);)r.pop()}return c+=h,{hits:l,start:o,end:n,searchTextCount:h}}function s(t,e){var o="",n=e.start;return e.hits.forEach(function(e){o+=t.substring(n,e.position);var r=e.position+e.length;o+='<b class="search-keyword">'+t.substring(e.position,r)+"</b>",n=r}),o+=t.substring(n,e.end)}var a=!1,i=0,c=0,l=n.title.trim(),h=l.toLowerCase(),p=n.content.trim().replace(/<[^>]+>/g,""),u=p.toLowerCase(),f=decodeURIComponent(n.url),d=[],g=[];if(""!=l&&(e.forEach(function(t){function e(t,e,o){var n=t.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(e=e.toLowerCase(),t=t.toLowerCase());(s=e.indexOf(t,r))>-1;)a.push({position:s,word:t}),r=s+n;return a}d=d.concat(e(t,h,!1)),g=g.concat(e(t,u,!1))}),(d.length>0||g.length>0)&&(a=!0,i=d.length+g.length)),a){[d,g].forEach(function(t){t.sort(function(t,e){return e.position!==t.position?e.position-t.position:t.word.length-e.word.length})});var v=[];0!=d.length&&v.push(r(l,0,l.length,d));for(var $=[];0!=g.length;){var C=g[g.length-1],m=C.position,x=C.word,w=m-20,y=m+80;0>w&&(w=0),y<m+x.length&&(y=m+x.length),y>p.length&&(y=p.length),$.push(r(p,w,y,g))}$.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hits.length!==e.hits.length?e.hits.length-t.hits.length:t.start-e.start});var T=parseInt("1");T>=0&&($=$.slice(0,T));var b="";b+=0!=v.length?"<li><a href='"+f+"' class='search-result-title'>"+s(l,v[0])+"</a>":"<li><a href='"+f+"' class='search-result-title'>"+l+"</a>",$.forEach(function(t){b+="<a href='"+f+'\'><p class="search-result">'+s(p,t)+"...</p></a>"}),b+="</li>",o.push({item:b,searchTextCount:c,hitCount:i,id:o.length})}}),1===e.length&&""===e[0])s.innerHTML='<div id="no-result"><i class="fas fa-search fa-5x" /></div>';else if(0===o.length)s.innerHTML='<div id="no-result"><i class="far fa-frown fa-5x" /></div>';else{o.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hitCount!==e.hitCount?e.hitCount-t.hitCount:e.id-t.id});var a='<ul class="search-result-list">';o.forEach(function(t){a+=t.item}),a+="</ul>",s.innerHTML=a}};r.addEventListener("input",a),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(t){t.stopPropagation(),isfetched===!1?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(t){t.stopPropagation()}),$(document).on("keyup",function(t){var e=27===t.which&&$(".search-popup").is(":visible");e&&onPopupClose()})</script><script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script><script>AV.initialize("1OiMg9cMz7owGf7apX4mTQs3-gzGzoHsz","nfafLPsFBNTdO9Sb5suuGdpG")</script><script>function showTime(e){var t=new AV.Query(e),n=[],o=$(".leancloud_visitors");o.each(function(){n.push($(this).attr("id").trim())}),t.containedIn("url",n),t.find().done(function(e){var t=".leancloud-visitors-count";if(0===e.length)return void o.find(t).text(0);for(var i=0;i<e.length;i++){var r=e[i],s=r.get("url"),l=r.get("time"),c=document.getElementById(s);$(c).find(t).text(l)}for(var i=0;i<n.length;i++){var s=n[i],c=document.getElementById(s),u=$(c).find(t);""==u.text()&&u.text(0)}}).fail(function(e,t){console.log("Error: "+t.code+" "+t.message)})}function addCount(e){var t=$(".leancloud_visitors"),n=t.attr("id").trim(),o=t.attr("data-flag-title").trim(),i=new AV.Query(e);i.equalTo("url",n),i.find({success:function(t){if(t.length>0){var i=t[0];i.fetchWhenSave(!0),i.increment("time"),i.save(null,{success:function(e){var t=$(document.getElementById(n));t.find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to save Visitor num, with error message: "+t.message)}})}else{var r=new e,s=new AV.ACL;s.setPublicReadAccess(!0),s.setPublicWriteAccess(!0),r.setACL(s),r.set("title",o),r.set("url",n),r.set("time",1),r.save(null,{success:function(e){var t=$(document.getElementById(n));t.find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to create")}})}},error:function(e){console.log("Error:"+e.code+" "+e.message)}})}$(function(){var e=AV.Object.extend("Counter");1==$(".leancloud_visitors").length?addCount(e):$(".post-title-link").length>1&&showTime(e)})</script><script>!function(){var t=document.createElement("script"),s=window.location.protocol.split(":")[0];"https"===s?t.src="https://zz.bdstatic.com/linksubmit/push.js":t.src="http://push.zhanzhang.baidu.com/push.js";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}()</script><script src="https://cdn.bootcss.com/jquery-backstretch/2.0.4/jquery.backstretch.min.js"></script><script type="text/javascript" src="/lib/zclip/clipboard.min.js"></script><script>$(function(){$(".site-avatar-plug-bilibili").attr("src","/images/avatar-plug/bilibili_"+(~~(44*Math.random())+1)+".png")})</script><script type="text/javascript" src="/js/src/custom.js"></script><script>!function(t){function e(t,e){var n=new Image,o=t.getAttribute("data-original");n.onload=function(){t.src=o,e&&e()},n.src=o}function n(){for(var n=0;n<o.length;n++)i=o[n],0<=(c=i.getBoundingClientRect()).top&&0<=c.left&&c.top<=(t.innerHeight||document.documentElement.clientHeight)&&e(o[n],function(){o.splice(n,n)});var i,c;console.log("trigger")}var o=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));n(),t.addEventListener("scroll",function(){var e,o;e=n,o=t,clearTimeout(e.tId),e.tId=setTimeout(function(){e.call(o)},500)})}(this)</script></body></html><!-- rebuild by neat -->